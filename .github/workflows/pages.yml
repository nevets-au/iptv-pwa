name: Build cleaned playlist

# allow the workflow to push back to the repo
permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # run every 6 hours

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download master playlist (iptv-org)
        run: |
          set -e
          echo "Downloading iptv-org master playlist..."
          curl -L "https://iptv-org.github.io/iptv/index.m3u" -o raw.m3u
          echo "Download finished. Size:"
          wc -c raw.m3u || true
          head -n 5 raw.m3u || true

      - name: Build cleaned playlist (keep only .m3u8)
        run: |
          mkdir -p playlist
          echo "#EXTM3U" > playlist/index.m3u
          awk '
          /^#EXTINF/ {info=$0; getline url;
            if (url ~ /\.m3u8($|\?)/) {
              print info >> "playlist/index.m3u";
              print url  >> "playlist/index.m3u";
            }
          }' raw.m3u || true
          echo "Cleaned playlist lines:"
          wc -l playlist/index.m3u || true
          echo "--- sample ---"
          head -n 40 playlist/index.m3u || true

      - name: Commit cleaned playlist
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add playlist/index.m3u || true
          git commit -m "Update cleaned playlist (automated)" || echo "No changes to commit"
          git push || echo "Push failed (will show in log)"
