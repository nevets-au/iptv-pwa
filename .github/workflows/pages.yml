name: Build cleaned playlist

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    # Hard cap — playlist build should never need more than 30 min
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download master playlist
        run: |
          set -euo pipefail
          echo "Downloading iptv-org master playlist..."
          curl -fL --max-time 60 \
            "https://iptv-org.github.io/iptv/index.m3u" \
            -o raw.m3u
          echo "Downloaded $(wc -l < raw.m3u) lines"

      # ── Fast approach: skip stream verification entirely ──
      # The iptv-org project already validates streams daily.
      # Trying to re-verify 10k+ streams from a GH Actions runner is
      # what caused the previous workflow to time out and produce an
      # empty playlist. We just filter by URL pattern instead.
      - name: Build filtered playlist (no per-stream curl)
        run: |
          set -euo pipefail
          mkdir -p playlist

          echo "#EXTM3U" > playlist/index.m3u

          # Parse EXTINF + URL pairs; keep only clear HLS/m3u8 URLs
          awk '
            /^#EXTINF/ {
              info = $0
              getline url
              # Trim whitespace
              gsub(/^[ \t]+|[ \t]+$/, "", url)
              # Accept http/https URLs that look like HLS streams
              if (url ~ /^https?:\/\// &&
                  (url ~ /\.m3u8([?#]|$)/ ||
                   url ~ /\.m3u([?#]|$)/  ||
                   url ~ /\/hls\//         ||
                   url ~ /\/live\//        ||
                   url ~ /\/stream\//      ||
                   url ~ /\/playlist\//)) {
                print info
                print url
              }
            }
          ' raw.m3u >> playlist/index.m3u

          TOTAL=$(grep -c '^#EXTINF' playlist/index.m3u || true)
          echo "Kept $TOTAL channels"
          echo "--- first 10 channels ---"
          grep -A1 '^#EXTINF' playlist/index.m3u | head -20 || true

          # Fail loudly if we ended up with nothing (bad download etc.)
          if [ "$TOTAL" -lt 10 ]; then
            echo "ERROR: Fewer than 10 channels found — something went wrong with the download or filter"
            exit 1
          fi

      - name: Commit and push cleaned playlist
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add playlist/index.m3u

          # Only commit if something actually changed
          if git diff --cached --quiet; then
            echo "No changes to commit — playlist unchanged"
            exit 0
          fi

          TOTAL=$(grep -c '^#EXTINF' playlist/index.m3u || echo "?")
          git commit -m "chore: update playlist ($TOTAL channels) [skip ci]"

          # Push using the default GITHUB_TOKEN
          git push origin HEAD:${{ github.ref_name }}
