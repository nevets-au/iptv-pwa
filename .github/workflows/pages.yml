name: Build and deploy IPTV playlist

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"
  push:
    branches: [main]

# Required permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Only allow one deployment at a time
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download English-only playlist
        run: |
          set -euo pipefail
          echo "Downloading English-only playlist from iptv-org..."
          curl -fL --max-time 60 \
            "https://iptv-org.github.io/iptv/languages/eng.m3u" \
            -o raw.m3u
          echo "Downloaded $(wc -l < raw.m3u) lines"

      - name: Build filtered playlist
        run: |
          set -euo pipefail
          mkdir -p playlist

          echo "#EXTM3U" > playlist/index.m3u

          awk '
            /^#EXTINF/ {
              info = $0
              getline url
              gsub(/^[ \t]+|[ \t]+$/, "", url)
              if (url ~ /^https?:\/\// &&
                  (url ~ /\.m3u8([?#]|$)/ ||
                   url ~ /\.m3u([?#]|$)/  ||
                   url ~ /\/hls\//         ||
                   url ~ /\/live\//        ||
                   url ~ /\/stream\//      ||
                   url ~ /\/playlist\//)) {
                print info
                print url
              }
            }
          ' raw.m3u >> playlist/index.m3u

          TOTAL=$(grep -c '^#EXTINF' playlist/index.m3u || true)
          echo "Kept $TOTAL channels"

          if [ "$TOTAL" -lt 10 ]; then
            echo "ERROR: Fewer than 10 channels â€” download or filter failed"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload site as Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # Upload the entire repo folder (index.html, manifest.json,
          # service-worker.js) PLUS the freshly built playlist/index.m3u
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
