<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <link rel="manifest" href="manifest.json">
  <title>IPTV PWA</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
  <style>
    *{box-sizing:border-box}
    body{font-family:-apple-system,system-ui,Roboto,Arial;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;background:#0a0a0a;color:#f0f0f0}
    header{padding:12px 16px;background:#111;border-bottom:1px solid #222;display:flex;align-items:center;gap:12px}
    header strong{font-size:16px}
    #airplayBtn{
      /* Must be directly on the video or a sibling â€” styled as a pill button */
      margin-left:auto;
      background:#1c1c1e;
      color:#fff;
      border:1px solid #444;
      border-radius:20px;
      padding:6px 14px;
      font-size:14px;
      cursor:pointer;
      /* IMPORTANT: needs -webkit-airplay on the element, not display:none */
    }
    #airplayBtn:active{background:#333}
    main{display:flex;gap:0;flex:1;overflow:hidden}
    #channels{width:300px;overflow:auto;border-right:1px solid #222;background:#111}
    .chan{padding:10px 12px;border-bottom:1px solid #1a1a1a;cursor:pointer;display:flex;align-items:center;gap:8px}
    .chan:hover,.chan.active{background:#1c1c1e}
    .chan.active{border-left:3px solid #0a84ff}
    .chan-name{font-size:14px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .chan-id{font-size:11px;color:#888;margin-top:2px}
    .logo{height:28px;width:28px;object-fit:contain;flex-shrink:0;border-radius:4px}
    #playerWrap{flex:1;display:flex;flex-direction:column;background:#000}
    #player{width:100%;height:60vh;background:#000;display:block}
    #nowPlaying{padding:10px 14px;font-size:13px;color:#aaa;background:#111;border-bottom:1px solid #222;min-height:36px}
    #airplayStatus{display:inline-block;margin-left:8px;font-size:12px;color:#0a84ff}
  </style>
</head>
<body>
  <header>
    <strong>ðŸ“º IPTV PWA</strong>
    <!--
      The AirPlay button MUST be in the same user-gesture call stack as
      webkitShowPlaybackTargetPicker(). We wire it up in JS below.
    -->
    <button id="airplayBtn" title="AirPlay">âŽ‹ AirPlay</button>
  </header>
  <main>
    <section id="channels"><em style="padding:12px;display:block;color:#666">Loadingâ€¦</em></section>
    <section id="playerWrap">
      <!--
        Key AirPlay attributes:
        - x-webkit-airplay="allow"  â†’ tells Safari this element can AirPlay
        - webkit-playsinline        â†’ keeps Safari from going fullscreen on iOS
        - playsinline               â†’ standard attribute
        DO NOT set mediagroup â€” it can break AirPlay target selection
      -->
      <video id="player"
             controls
             playsinline
             webkit-playsinline
             x-webkit-airplay="allow">
      </video>
      <div id="nowPlaying">No channel selected<span id="airplayStatus"></span></div>
    </section>
  </main>

<script>
const PLAYLIST_URL = "playlist/index.m3u?v=" + Date.now();
let currentChannel = null;

/* â”€â”€ Playlist fetch + parse â”€â”€ */
async function fetchText(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error(r.statusText);
  return r.text();
}

function parseM3U(text){
  const lines = text.split(/\r?\n/);
  const channels = [];
  for(let i = 0; i < lines.length; i++){
    const l = lines[i].trim();
    if(!l.startsWith("#EXTINF")) continue;
    const name    = l.split(",").slice(1).join(",").trim();
    const tvgLogo = (l.match(/tvg-logo="([^"]+)"/)  || [,null])[1] || "";
    const tvgId   = (l.match(/tvg-id="([^"]+)"/)    || [,null])[1] || "";
    const url     = (lines[i+1]||"").trim();
    if(url) channels.push({name, tvgLogo, tvgId, url});
  }
  return channels;
}

/* â”€â”€ Channel list render â”€â”€ */
function renderChannels(channels){
  const el = document.getElementById('channels');
  el.innerHTML = "";
  if(!channels.length){
    el.innerHTML = "<em style='padding:12px;display:block;color:#888'>Playlist empty â€” run the GitHub Action.</em>";
    return;
  }
  channels.forEach(c => {
    const div = document.createElement('div');
    div.className = 'chan';
    div.innerHTML =
      `<img class="logo" src="${c.tvgLogo||''}" onerror="this.style.visibility='hidden'">
       <div><div class="chan-name">${c.name}</div><div class="chan-id">${c.tvgId||''}</div></div>`;
    div.addEventListener('click', () => playChannel(c, div));
    el.appendChild(div);
  });
}

/* â”€â”€ Playback â”€â”€ */
function playChannel(c, divEl){
  // Highlight active
  document.querySelectorAll('.chan.active').forEach(d => d.classList.remove('active'));
  if(divEl) divEl.classList.add('active');

  currentChannel = c;
  document.getElementById('nowPlaying').innerHTML =
    `â–¶ ${c.name}<span id="airplayStatus"></span>`;

  const player = document.getElementById('player');

  // Safari on iOS/macOS: native HLS â€” just set src, AirPlay works natively
  if(player.canPlayType('application/vnd.apple.mpegurl')){
    player.src = c.url;
    player.load();
    player.play().catch(e => console.warn("Play failed:", e));
    return;
  }

  // Chrome/Firefox/Edge: use hls.js
  if(window.Hls && Hls.isSupported()){
    if(window._hls){ window._hls.destroy(); window._hls = null; }
    const hls = new Hls({enableWorker:true});
    window._hls = hls;
    hls.loadSource(c.url);
    hls.attachMedia(player);
    hls.on(Hls.Events.MANIFEST_PARSED, () => player.play().catch(e => console.warn(e)));
    hls.on(Hls.Events.ERROR, (_, data) => {
      if(data.fatal) console.warn("HLS fatal error:", data);
    });
    return;
  }

  player.src = c.url;
  player.play().catch(e => console.warn("Play failed:", e));
}

/* â”€â”€ AirPlay â”€â”€
   Safari requires webkitShowPlaybackTargetPicker() to be called
   SYNCHRONOUSLY inside a user gesture handler (touchend / click).
   Calling it after any await or setTimeout breaks it.
   The button click here is a direct synchronous call â€” no async gap.
*/
document.getElementById('airplayBtn').addEventListener('click', function(){
  const player = document.getElementById('player');
  if(!player.src && !player.currentSrc){
    alert("Select a channel first, then tap AirPlay.");
    return;
  }
  if(typeof player.webkitShowPlaybackTargetPicker === 'function'){
    player.webkitShowPlaybackTargetPicker();
  } else {
    alert("AirPlay is only available in Safari. Use the AirPlay icon in Safari's video controls instead.");
  }
});

/* â”€â”€ AirPlay status events â”€â”€ */
const player = document.getElementById('player');

player.addEventListener('webkitplaybacktargetavailabilitychanged', function(e){
  const btn = document.getElementById('airplayBtn');
  btn.style.display = (e.availability === 'available') ? 'block' : 'none';
});

player.addEventListener('webkitcurrentplaybacktargetiswirelesschanged', function(){
  const status = document.getElementById('airplayStatus');
  if(player.webkitCurrentPlaybackTargetIsWireless){
    status.textContent = " Â· ðŸ“¡ AirPlaying";
  } else {
    status.textContent = "";
  }
});

/* â”€â”€ Init â”€â”€ */
async function init(){
  try{
    const m3u = await fetchText(PLAYLIST_URL);
    renderChannels(parseM3U(m3u));
  } catch(err){
    document.getElementById('channels').innerHTML =
      `<em style='padding:12px;display:block;color:#f66'>Failed to load playlist: ${err.message}</em>`;
  }
}

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js')
    .then(reg => reg.update())
    .catch(e => console.warn(e));
}

init();
</script>
</body>
</html>
